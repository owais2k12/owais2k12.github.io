I"˜u<h4 id="type">type()</h4>

<p>åŠ¨æ€è¯­è¨€å’Œé™æ€è¯­è¨€æœ€å¤§çš„ä¸åŒï¼Œå°±æ˜¯å‡½æ•°å’Œç±»çš„å®šä¹‰ï¼Œä¸æ˜¯ç¼–è¯‘æ—¶å®šä¹‰çš„ï¼Œè€Œæ˜¯è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„ã€‚</p>

<p>æ¯”æ–¹è¯´æˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Hello</code>çš„classï¼Œå°±å†™ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">hello.py</code>æ¨¡å—ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Hello</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'world'</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Hello, %s.'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>å½“Pythonè§£é‡Šå™¨è½½å…¥<code class="language-plaintext highlighter-rouge">hello</code>æ¨¡å—æ—¶ï¼Œå°±ä¼šä¾æ¬¡æ‰§è¡Œè¯¥æ¨¡å—çš„æ‰€æœ‰è¯­å¥ï¼Œæ‰§è¡Œç»“æœå°±æ˜¯åŠ¨æ€åˆ›å»ºå‡ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Hello</code>çš„classå¯¹è±¡ï¼Œæµ‹è¯•å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; from hello import Hello
&gt;&gt;&gt; h = Hello()
&gt;&gt;&gt; h.hello()
Hello, world.
&gt;&gt;&gt; print(type(Hello))
&lt;type 'type'&gt;
&gt;&gt;&gt; print(type(h))
&lt;class 'hello.Hello'&gt;
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç±»å‹æˆ–å˜é‡çš„ç±»å‹ï¼Œ<code class="language-plaintext highlighter-rouge">Hello</code>æ˜¯ä¸€ä¸ªclassï¼Œå®ƒçš„ç±»å‹å°±æ˜¯<code class="language-plaintext highlighter-rouge">type</code>ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">h</code>æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œå®ƒçš„ç±»å‹å°±æ˜¯class <code class="language-plaintext highlighter-rouge">Hello</code>ã€‚</p>

<p>æˆ‘ä»¬è¯´classçš„å®šä¹‰æ˜¯è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„ï¼Œè€Œåˆ›å»ºclassçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°æ—¢å¯ä»¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œåˆå¯ä»¥åˆ›å»ºå‡ºæ–°çš„ç±»å‹ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°åˆ›å»ºå‡º<code class="language-plaintext highlighter-rouge">Hello</code>ç±»ï¼Œè€Œæ— éœ€é€šè¿‡<code class="language-plaintext highlighter-rouge">class Hello(object)...</code>çš„å®šä¹‰ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; def fn(self, name='world'): # å…ˆå®šä¹‰å‡½æ•°
...     print('Hello, %s.' % name)
...
&gt;&gt;&gt; Hello = type('Hello', (object,), dict(hello=fn)) # åˆ›å»ºHello class
&gt;&gt;&gt; h = Hello()
&gt;&gt;&gt; h.hello()
Hello, world.
&gt;&gt;&gt; print(type(Hello))
&lt;type 'type'&gt;
&gt;&gt;&gt; print(type(h))
&lt;class '__main__.Hello'&gt;
</code></pre></div></div>

<p>è¦åˆ›å»ºä¸€ä¸ªclasså¯¹è±¡ï¼Œ<code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°ä¾æ¬¡ä¼ å…¥3ä¸ªå‚æ•°ï¼š</p>

<ol>
  <li>
    <p>classçš„åç§°ï¼›</p>
  </li>
  <li>
    <p>ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼Œæ³¨æ„Pythonæ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçˆ¶ç±»ï¼Œåˆ«å¿˜äº†tupleçš„å•å…ƒç´ å†™æ³•ï¼›</p>
  </li>
  <li>
    <p>classçš„æ–¹æ³•åç§°ä¸å‡½æ•°ç»‘å®šï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠå‡½æ•°fnç»‘å®šåˆ°æ–¹æ³•åhelloä¸Šã€‚</p>
  </li>
</ol>

<p>é€šè¿‡<code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°åˆ›å»ºçš„ç±»å’Œç›´æ¥å†™classæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå› ä¸ºPythonè§£é‡Šå™¨é‡åˆ°classå®šä¹‰æ—¶ï¼Œä»…ä»…æ˜¯æ‰«æä¸€ä¸‹classå®šä¹‰çš„è¯­æ³•ï¼Œç„¶åè°ƒç”¨<code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°åˆ›å»ºå‡ºclassã€‚</p>

<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ç”¨<code class="language-plaintext highlighter-rouge">class Xxx...</code>æ¥å®šä¹‰ç±»ï¼Œä½†æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">type()</code>å‡½æ•°ä¹Ÿå…è®¸æˆ‘ä»¬åŠ¨æ€åˆ›å»ºå‡ºç±»æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€è¯­è¨€æœ¬èº«æ”¯æŒè¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºç±»ï¼Œè¿™å’Œé™æ€è¯­è¨€æœ‰éå¸¸å¤§çš„ä¸åŒï¼Œè¦åœ¨é™æ€è¯­è¨€è¿è¡ŒæœŸåˆ›å»ºç±»ï¼Œå¿…é¡»æ„é€ æºä»£ç å­—ç¬¦ä¸²å†è°ƒç”¨ç¼–è¯‘å™¨ï¼Œæˆ–è€…å€ŸåŠ©ä¸€äº›å·¥å…·ç”Ÿæˆå­—èŠ‚ç å®ç°ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŠ¨æ€ç¼–è¯‘ï¼Œä¼šéå¸¸å¤æ‚ã€‚</p>

<h4 id="metaclass">metaclass</h4>

<p>é™¤äº†ä½¿ç”¨<code class="language-plaintext highlighter-rouge">type()</code>åŠ¨æ€åˆ›å»ºç±»ä»¥å¤–ï¼Œè¦æ§åˆ¶ç±»çš„åˆ›å»ºè¡Œä¸ºï¼Œè¿˜å¯ä»¥ä½¿ç”¨metaclassã€‚</p>

<p>metaclassï¼Œç›´è¯‘ä¸ºå…ƒç±»ï¼Œç®€å•çš„è§£é‡Šå°±æ˜¯ï¼š</p>

<p>å½“æˆ‘ä»¬å®šä¹‰äº†ç±»ä»¥åï¼Œå°±å¯ä»¥æ ¹æ®è¿™ä¸ªç±»åˆ›å»ºå‡ºå®ä¾‹ï¼Œæ‰€ä»¥ï¼šå…ˆå®šä¹‰ç±»ï¼Œç„¶ååˆ›å»ºå®ä¾‹ã€‚</p>

<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³åˆ›å»ºå‡ºç±»å‘¢ï¼Ÿé‚£å°±å¿…é¡»æ ¹æ®metaclassåˆ›å»ºå‡ºç±»ï¼Œæ‰€ä»¥ï¼šå…ˆå®šä¹‰metaclassï¼Œç„¶ååˆ›å»ºç±»ã€‚</p>

<p>è¿æ¥èµ·æ¥å°±æ˜¯ï¼šå…ˆå®šä¹‰metaclassï¼Œå°±å¯ä»¥åˆ›å»ºç±»ï¼Œæœ€ååˆ›å»ºå®ä¾‹ã€‚</p>

<p>æ‰€ä»¥ï¼Œmetaclasså…è®¸ä½ åˆ›å»ºç±»æˆ–è€…ä¿®æ”¹ç±»ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥æŠŠç±»çœ‹æˆæ˜¯metaclassåˆ›å»ºå‡ºæ¥çš„â€œå®ä¾‹â€ã€‚</p>

<p>metaclassæ˜¯Pythoné¢å‘å¯¹è±¡é‡Œæœ€éš¾ç†è§£ï¼Œä¹Ÿæ˜¯æœ€éš¾ä½¿ç”¨çš„é­”æœ¯ä»£ç ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½ ä¸ä¼šç¢°åˆ°éœ€è¦ä½¿ç”¨metaclassçš„æƒ…å†µï¼Œæ‰€ä»¥ï¼Œä»¥ä¸‹å†…å®¹çœ‹ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºåŸºæœ¬ä¸Šä½ ä¸ä¼šç”¨åˆ°ã€‚</p>

<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¿™ä¸ªmetaclasså¯ä»¥ç»™æˆ‘ä»¬è‡ªå®šä¹‰çš„MyListå¢åŠ ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">add</code>æ–¹æ³•ï¼š</p>

<p>å®šä¹‰<code class="language-plaintext highlighter-rouge">ListMetaclass</code>ï¼ŒæŒ‰ç…§é»˜è®¤ä¹ æƒ¯ï¼Œmetaclassçš„ç±»åæ€»æ˜¯ä»¥Metaclassç»“å°¾ï¼Œä»¥ä¾¿æ¸…æ¥šåœ°è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªmetaclassï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># metaclassæ˜¯åˆ›å»ºç±»ï¼Œæ‰€ä»¥å¿…é¡»ä»`type`ç±»å‹æ´¾ç”Ÿï¼š
</span><span class="k">class</span> <span class="nc">ListMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'add'</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ListMetaclass</span> <span class="c1"># æŒ‡ç¤ºä½¿ç”¨ListMetaclassæ¥å®šåˆ¶ç±»
</span></code></pre></div></div>

<p>å½“æˆ‘ä»¬å†™ä¸‹<code class="language-plaintext highlighter-rouge">__metaclass__ = ListMetaclass</code>è¯­å¥æ—¶ï¼Œé­”æœ¯å°±ç”Ÿæ•ˆäº†ï¼Œå®ƒæŒ‡ç¤ºPythonè§£é‡Šå™¨åœ¨åˆ›å»º<code class="language-plaintext highlighter-rouge">MyList</code>æ—¶ï¼Œè¦é€šè¿‡<code class="language-plaintext highlighter-rouge">ListMetaclass.__new__()</code>æ¥åˆ›å»ºï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ç±»çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼ŒåŠ ä¸Šæ–°çš„æ–¹æ³•ï¼Œç„¶åï¼Œè¿”å›ä¿®æ”¹åçš„å®šä¹‰ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">__new__()</code>æ–¹æ³•æ¥æ”¶åˆ°çš„å‚æ•°ä¾æ¬¡æ˜¯ï¼š</p>

<ol>
  <li>
    <p>å½“å‰å‡†å¤‡åˆ›å»ºçš„ç±»çš„å¯¹è±¡ï¼›</p>
  </li>
  <li>
    <p>ç±»çš„åå­—ï¼›</p>
  </li>
  <li>
    <p>ç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼›</p>
  </li>
  <li>
    <p>ç±»çš„æ–¹æ³•é›†åˆã€‚</p>
  </li>
</ol>

<p>æµ‹è¯•ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">MyList</code>æ˜¯å¦å¯ä»¥è°ƒç”¨<code class="language-plaintext highlighter-rouge">add()</code>æ–¹æ³•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; L = MyList()
&gt;&gt;&gt; L.add(1)
&gt;&gt;&gt; L
[1]
</code></pre></div></div>

<p>è€Œæ™®é€šçš„<code class="language-plaintext highlighter-rouge">list</code>æ²¡æœ‰<code class="language-plaintext highlighter-rouge">add()</code>æ–¹æ³•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; l = list()
&gt;&gt;&gt; l.add(1)
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
AttributeError: 'list' object has no attribute 'add'
</code></pre></div></div>

<p>åŠ¨æ€ä¿®æ”¹æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿç›´æ¥åœ¨<code class="language-plaintext highlighter-rouge">MyList</code>å®šä¹‰ä¸­å†™ä¸Š<code class="language-plaintext highlighter-rouge">add()</code>æ–¹æ³•ä¸æ˜¯æ›´ç®€å•å—ï¼Ÿæ­£å¸¸æƒ…å†µä¸‹ï¼Œç¡®å®åº”è¯¥ç›´æ¥å†™ï¼Œé€šè¿‡metaclassä¿®æ”¹çº¯å±å˜æ€ã€‚</p>

<p>ä½†æ˜¯ï¼Œæ€»ä¼šé‡åˆ°éœ€è¦é€šè¿‡metaclassä¿®æ”¹ç±»å®šä¹‰çš„ã€‚ORMå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ã€‚</p>

<p>ORMå…¨ç§°â€œObject Relational Mappingâ€ï¼Œå³å¯¹è±¡-å…³ç³»æ˜ å°„ï¼Œå°±æ˜¯æŠŠå…³ç³»æ•°æ®åº“çš„ä¸€è¡Œæ˜ å°„ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªè¡¨ï¼Œè¿™æ ·ï¼Œå†™ä»£ç æ›´ç®€å•ï¼Œä¸ç”¨ç›´æ¥æ“ä½œSQLè¯­å¥ã€‚</p>

<p>è¦ç¼–å†™ä¸€ä¸ªORMæ¡†æ¶ï¼Œæ‰€æœ‰çš„ç±»éƒ½åªèƒ½åŠ¨æ€å®šä¹‰ï¼Œå› ä¸ºåªæœ‰ä½¿ç”¨è€…æ‰èƒ½æ ¹æ®è¡¨çš„ç»“æ„å®šä¹‰å‡ºå¯¹åº”çš„ç±»æ¥ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥å°è¯•ç¼–å†™ä¸€ä¸ªORMæ¡†æ¶ã€‚</p>

<p>ç¼–å†™åº•å±‚æ¨¡å—çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å…ˆæŠŠè°ƒç”¨æ¥å£å†™å‡ºæ¥ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨è€…å¦‚æœä½¿ç”¨è¿™ä¸ªORMæ¡†æ¶ï¼Œæƒ³å®šä¹‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">User</code>ç±»æ¥æ“ä½œå¯¹åº”çš„æ•°æ®åº“è¡¨<code class="language-plaintext highlighter-rouge">User</code>ï¼Œæˆ‘ä»¬æœŸå¾…ä»–å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># å®šä¹‰ç±»çš„å±æ€§åˆ°åˆ—çš„æ˜ å°„ï¼š
</span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'username'</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'email'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'password'</span><span class="p">)</span>

<span class="c1"># åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š
</span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Michael'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'test@orm.org'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'my-pwd'</span><span class="p">)</span>
<span class="c1"># ä¿å­˜åˆ°æ•°æ®åº“ï¼š
</span><span class="n">u</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>å…¶ä¸­ï¼Œçˆ¶ç±»<code class="language-plaintext highlighter-rouge">Model</code>å’Œå±æ€§ç±»å‹<code class="language-plaintext highlighter-rouge">StringField</code>ã€<code class="language-plaintext highlighter-rouge">IntegerField</code>æ˜¯ç”±ORMæ¡†æ¶æä¾›çš„ï¼Œå‰©ä¸‹çš„é­”æœ¯æ–¹æ³•æ¯”å¦‚<code class="language-plaintext highlighter-rouge">save()</code>å…¨éƒ¨ç”±metaclassè‡ªåŠ¨å®Œæˆã€‚è™½ç„¶metaclassçš„ç¼–å†™ä¼šæ¯”è¾ƒå¤æ‚ï¼Œä½†ORMçš„ä½¿ç”¨è€…ç”¨èµ·æ¥å´å¼‚å¸¸ç®€å•ã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æŒ‰ä¸Šé¢çš„æ¥å£æ¥å®ç°è¯¥ORMã€‚</p>

<p>é¦–å…ˆæ¥å®šä¹‰<code class="language-plaintext highlighter-rouge">Field</code>ç±»ï¼Œå®ƒè´Ÿè´£ä¿å­˜æ•°æ®åº“è¡¨çš„å­—æ®µåå’Œå­—æ®µç±»å‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">column_type</span> <span class="o">=</span> <span class="n">column_type</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'&lt;%s:%s&gt;'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨<code class="language-plaintext highlighter-rouge">Field</code>çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å®šä¹‰å„ç§ç±»å‹çš„<code class="language-plaintext highlighter-rouge">Field</code>ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">StringField</code>ï¼Œ<code class="language-plaintext highlighter-rouge">IntegerField</code>ç­‰ç­‰ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StringField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StringField</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">'varchar(100)'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">IntegerField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IntegerField</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">'bigint'</span><span class="p">)</span>
</code></pre></div></div>

<p>ä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯ç¼–å†™æœ€å¤æ‚çš„<code class="language-plaintext highlighter-rouge">ModelMetaclass</code>äº†ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ModelMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s">'Model'</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'Found mapping: %s==&gt;%s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">attrs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'__table__'</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="c1"># å‡è®¾è¡¨åå’Œç±»åä¸€è‡´
</span>        <span class="n">attrs</span><span class="p">[</span><span class="s">'__mappings__'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mappings</span> <span class="c1"># ä¿å­˜å±æ€§å’Œåˆ—çš„æ˜ å°„å…³ç³»
</span>        <span class="k">return</span> <span class="nb">type</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</code></pre></div></div>

<p>ä»¥åŠåŸºç±»<code class="language-plaintext highlighter-rouge">Model</code>ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ModelMetaclass</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">AttributeError</span><span class="p">(</span><span class="sa">r</span><span class="s">"'Model' object has no attribute '%s'"</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">__mappings__</span><span class="p">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">fields</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">params</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'?'</span><span class="p">)</span>
            <span class="n">args</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">'insert into %s (%s) values (%s)'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__table__</span><span class="p">,</span> <span class="s">','</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="s">','</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'SQL: %s'</span> <span class="o">%</span> <span class="n">sql</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'ARGS: %s'</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</code></pre></div></div>

<p>å½“ç”¨æˆ·å®šä¹‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">class User(Model)</code>æ—¶ï¼ŒPythonè§£é‡Šå™¨é¦–å…ˆåœ¨å½“å‰ç±»<code class="language-plaintext highlighter-rouge">User</code>çš„å®šä¹‰ä¸­æŸ¥æ‰¾<code class="language-plaintext highlighter-rouge">__metaclass__</code>ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ç»§ç»­åœ¨çˆ¶ç±»<code class="language-plaintext highlighter-rouge">Model</code>ä¸­æŸ¥æ‰¾<code class="language-plaintext highlighter-rouge">__metaclass__</code>ï¼Œæ‰¾åˆ°äº†ï¼Œå°±ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Model</code>ä¸­å®šä¹‰çš„<code class="language-plaintext highlighter-rouge">__metaclass__</code>çš„<code class="language-plaintext highlighter-rouge">ModelMetaclass</code>æ¥åˆ›å»º<code class="language-plaintext highlighter-rouge">User</code>ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œmetaclasså¯ä»¥éšå¼åœ°ç»§æ‰¿åˆ°å­ç±»ï¼Œä½†å­ç±»è‡ªå·±å´æ„Ÿè§‰ä¸åˆ°ã€‚</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">ModelMetaclass</code>ä¸­ï¼Œä¸€å…±åšäº†å‡ ä»¶äº‹æƒ…ï¼š</p>

<ol>
  <li>
    <p>æ’é™¤æ‰å¯¹<code class="language-plaintext highlighter-rouge">Model</code>ç±»çš„ä¿®æ”¹ï¼›</p>
  </li>
  <li>
    <p>åœ¨å½“å‰ç±»ï¼ˆæ¯”å¦‚<code class="language-plaintext highlighter-rouge">User</code>ï¼‰ä¸­æŸ¥æ‰¾å®šä¹‰çš„ç±»çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªFieldå±æ€§ï¼Œå°±æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">__mappings__</code>çš„dictä¸­ï¼ŒåŒæ—¶ä»ç±»å±æ€§ä¸­åˆ é™¤è¯¥Fieldå±æ€§ï¼Œå¦åˆ™ï¼Œå®¹æ˜“é€ æˆè¿è¡Œæ—¶é”™è¯¯ï¼›</p>
  </li>
  <li>
    <p>æŠŠè¡¨åä¿å­˜åˆ°<code class="language-plaintext highlighter-rouge">__table__</code>ä¸­ï¼Œè¿™é‡Œç®€åŒ–ä¸ºè¡¨åé»˜è®¤ä¸ºç±»åã€‚</p>
  </li>
</ol>

<p>åœ¨<code class="language-plaintext highlighter-rouge">Model</code>ç±»ä¸­ï¼Œå°±å¯ä»¥å®šä¹‰å„ç§æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">save()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">delete()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">find()</code>ï¼Œ<code class="language-plaintext highlighter-rouge">update</code>ç­‰ç­‰ã€‚</p>

<p>æˆ‘ä»¬å®ç°äº†<code class="language-plaintext highlighter-rouge">save()</code>æ–¹æ³•ï¼ŒæŠŠä¸€ä¸ªå®ä¾‹ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚å› ä¸ºæœ‰è¡¨åï¼Œå±æ€§åˆ°å­—æ®µçš„æ˜ å°„å’Œå±æ€§å€¼çš„é›†åˆï¼Œå°±å¯ä»¥æ„é€ å‡ºINSERTè¯­å¥ã€‚</p>

<p>ç¼–å†™ä»£ç è¯•è¯•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Michael'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'test@orm.org'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'my-pwd'</span><span class="p">)</span>
<span class="n">u</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Found model: User
Found mapping: email ==&gt; &lt;StringField:email&gt;
Found mapping: password ==&gt; &lt;StringField:password&gt;
Found mapping: id ==&gt; &lt;IntegerField:uid&gt;
Found mapping: name ==&gt; &lt;StringField:username&gt;
SQL: insert into User (password,email,username,uid) values (?,?,?,?)
ARGS: ['my-pwd', 'test@orm.org', 'Michael', 12345]
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code class="language-plaintext highlighter-rouge">save()</code>æ–¹æ³•å·²ç»æ‰“å°å‡ºäº†å¯æ‰§è¡Œçš„SQLè¯­å¥ï¼Œä»¥åŠå‚æ•°åˆ—è¡¨ï¼Œåªéœ€è¦çœŸæ­£è¿æ¥åˆ°æ•°æ®åº“ï¼Œæ‰§è¡Œè¯¥SQLè¯­å¥ï¼Œå°±å¯ä»¥å®ŒæˆçœŸæ­£çš„åŠŸèƒ½ã€‚</p>

<p>ä¸åˆ°100è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±é€šè¿‡metaclasså®ç°äº†ä¸€ä¸ªç²¾ç®€çš„ORMæ¡†æ¶ï¼Œå®Œæ•´çš„ä»£ç ä»è¿™é‡Œä¸‹è½½ï¼š</p>

<p><a href="https://github.com/michaelliao/learn-python/blob/master/metaclass/simple_orm.py">https://github.com/michaelliao/learn-python/blob/master/metaclass/simple_orm.py</a></p>

<p>æœ€åè§£é‡Šä¸€ä¸‹ç±»å±æ€§å’Œå®ä¾‹å±æ€§ã€‚ç›´æ¥åœ¨classä¸­å®šä¹‰çš„æ˜¯ç±»å±æ€§ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">'Student'</span>
</code></pre></div></div>

<p>å®ä¾‹å±æ€§å¿…é¡»é€šè¿‡å®ä¾‹æ¥ç»‘å®šï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">self.name = 'xxx'</code>ã€‚æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; # åˆ›å»ºå®ä¾‹sï¼š
&gt;&gt;&gt; s = Student()
&gt;&gt;&gt; # æ‰“å°nameå±æ€§ï¼Œå› ä¸ºå®ä¾‹å¹¶æ²¡æœ‰nameå±æ€§ï¼Œæ‰€ä»¥ä¼šç»§ç»­æŸ¥æ‰¾classçš„nameå±æ€§ï¼š
&gt;&gt;&gt; print(s.name)
Student
&gt;&gt;&gt; # è¿™å’Œè°ƒç”¨Student.nameæ˜¯ä¸€æ ·çš„ï¼š
&gt;&gt;&gt; print(Student.name)
Student
&gt;&gt;&gt; # ç»™å®ä¾‹ç»‘å®šnameå±æ€§ï¼š
&gt;&gt;&gt; s.name = 'Michael'
&gt;&gt;&gt; # ç”±äºå®ä¾‹å±æ€§ä¼˜å…ˆçº§æ¯”ç±»å±æ€§é«˜ï¼Œå› æ­¤ï¼Œå®ƒä¼šå±è”½æ‰ç±»çš„nameå±æ€§ï¼š
&gt;&gt;&gt; print(s.name)
Michael
&gt;&gt;&gt; # ä½†æ˜¯ç±»å±æ€§å¹¶æœªæ¶ˆå¤±ï¼Œç”¨Student.nameä»ç„¶å¯ä»¥è®¿é—®ï¼š
&gt;&gt;&gt; print(Student.name)
Student
&gt;&gt;&gt; # å¦‚æœåˆ é™¤å®ä¾‹çš„nameå±æ€§ï¼š
&gt;&gt;&gt; del s.name
&gt;&gt;&gt; # å†æ¬¡è°ƒç”¨s.nameï¼Œç”±äºå®ä¾‹çš„nameå±æ€§æ²¡æœ‰æ‰¾åˆ°ï¼Œç±»çš„nameå±æ€§å°±æ˜¾ç¤ºå‡ºæ¥äº†ï¼š
&gt;&gt;&gt; print(s.name)
Student

</code></pre></div></div>

<p>å› æ­¤ï¼Œåœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™ï¼Œåƒä¸‡ä¸è¦æŠŠå®ä¾‹å±æ€§å’Œç±»å±æ€§ä½¿ç”¨ç›¸åŒçš„åå­—ã€‚</p>

<p>åœ¨æˆ‘ä»¬ç¼–å†™çš„ORMä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">ModelMetaclass</code>ä¼šåˆ é™¤æ‰Userç±»çš„æ‰€æœ‰ç±»å±æ€§ï¼Œç›®çš„å°±æ˜¯é¿å…é€ æˆæ··æ·†ã€‚</p>

<p>è½¬è‡ª<a href="http://www.liaoxuefeng.com">å»–é›ªå³°</a>çš„ç½‘ç«™</p>
:ET